{
  "kind": "build_request",
  "title": "Fix deployment error from Version 20 and redeploy",
  "projectName": "WoodworkbyTanishas",
  "priority": "high",
  "requirements": [
    {
      "id": "REQ-94",
      "text": "Audit and fix all compilation and runtime errors in `backend/main.mo` that caused the Version 20 deployment to fail. Ensure the paginated `listProducts(offset: Nat, limit: Nat)` endpoint compiles cleanly, has no authorization guard, returns `{ products: [Product]; total: Nat }`, and does not exceed the IC message size limit. Remove any unbounded `listProducts` call that returns all products at once.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "fix it and deploy again",
          "Version 20 deployment failed — fix and redeploy requested"
        ]
      },
      "acceptanceCriteria": [
        "The Motoko backend compiles without errors or warnings that block deployment.",
        "The `listProducts(offset: Nat, limit: Nat)` endpoint exists, accepts offset and limit parameters, and returns `{ products: [Product]; total: Nat }`.",
        "No authorization guard is applied to `listProducts` — anonymous and authenticated callers can both call it.",
        "No unbounded (no-parameter) `listProducts` endpoint that returns all products exists.",
        "The canister deploys successfully to the IC network without IC0504 payload size errors."
      ]
    },
    {
      "id": "REQ-95",
      "text": "Audit and fix all TypeScript compilation errors in the frontend that caused the Version 20 deployment to fail. Ensure `frontend/src/hooks/useQueries.ts`, `frontend/src/components/AdminProductsSection.tsx`, and `frontend/src/pages/Collection.tsx` correctly call the paginated `listProducts(offset, limit)` endpoint, handle the `{ products, total }` response shape, and compile without type errors.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "fix it and deploy again",
          "Version 20 deployment failed — fix and redeploy requested"
        ]
      },
      "acceptanceCriteria": [
        "The frontend TypeScript build completes without errors.",
        "`useQueries.ts` exports a hook that calls `listProducts(offset, limit)` and returns both `products` array and `total` count.",
        "`AdminProductsSection.tsx` uses the paginated hook, fetches 10 products on mount, and shows a 'Load More' button that appends the next 10.",
        "`Collection.tsx` uses the paginated hook, fetches 10 products on mount, and shows a 'Load More' button that appends the next 10.",
        "The frontend bundle builds and serves correctly after deployment."
      ]
    },
    {
      "id": "REQ-96",
      "text": "Fix the authenticated actor construction so that `createActor` is never called with both an `agent` parameter and `agentOptions` simultaneously. When an authenticated Internet Identity is present, construct a single `HttpAgent` from that identity and pass only the `agent` parameter. When unauthenticated, pass only `agentOptions` with the anonymous configuration. This ensures the correct non-anonymous principal is forwarded to all backend calls including admin endpoints, resolving the 'Actor not available' error in `ProductForm`.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "Actor not available - please ensure you are logged in' error appears when saving products in admin panel — authenticated actor not properly initialized"
        ]
      },
      "acceptanceCriteria": [
        "`createActor` is never invoked with both `agent` and `agentOptions` at the same time.",
        "After a successful Internet Identity login, the actor is immediately available as a non-null reference.",
        "Admin panel product add/edit/delete operations succeed without 'Actor not available' errors.",
        "Unauthenticated (anonymous) actor is used when no identity is present."
      ]
    }
  ],
  "constraints": [
    "Do not modify files listed in frontend.immutablePaths: useInternetIdentity.ts, useActor.ts, main.tsx, frontend/src/components/ui.",
    "All Motoko logic must remain in the single actor in backend/main.mo.",
    "Do not revert or remove existing paginated listProducts implementation — only fix compilation and runtime errors."
  ],
  "nonGoals": [
    "Adding new features beyond what was attempted in Version 20.",
    "Changing the authentication model or admin access logic beyond fixing the actor construction bug.",
    "Modifying the visual design or layout of any page."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}